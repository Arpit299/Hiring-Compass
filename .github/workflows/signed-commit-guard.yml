name: Signed Commit Guard

on:
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pull-requests: read

jobs:
  signed-commit-guard:
    runs-on: ubuntu-latest
    steps:
      - name: Verify all PR commits are signed
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            const commits = await github.paginate(
              github.rest.pulls.listCommits,
              { owner, repo, pull_number, per_page: 100 }
            );

            const unsigned = commits.filter(c => !c.commit?.verification?.verified);

            if (unsigned.length > 0) {
              core.setFailed(
                `Unsigned/unverified commits found: ${unsigned
                  .map(c => `${c.sha.substring(0, 8)} (${c.commit?.verification?.reason || 'unknown'})`)
                  .join(', ')}`
              );
              return;
            }

            core.info(`All ${commits.length} commits are signed and verified.`);
