name: Signed Commit Guard

on:
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pull-requests: read

jobs:
  signed-commit-guard:
    runs-on: ubuntu-latest
    steps:
      - name: Verify all PR commits are signed
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            const commits = await github.paginate(
              github.rest.pulls.listCommits,
              { owner, repo, pull_number, per_page: 100 }
            );

            const unverified = commits.filter(c => !c.commit?.verification?.verified);
            const blockingUnverified = unverified.filter(c => {
              const reason = c.commit?.verification?.reason || 'unknown';
              return reason !== 'unsigned';
            });

            const unsigned = unverified.filter(c => {
              const reason = c.commit?.verification?.reason || 'unknown';
              return reason === 'unsigned';
            });

            if (unsigned.length > 0) {
              core.warning(
                `Unsigned commits detected (allowed by this guard, enforced by branch protection): ${unsigned
                  .map(c => `${c.sha.substring(0, 8)} (${c.commit?.verification?.reason || 'unknown'})`)
                  .join(', ')}`
              );
            }

            if (blockingUnverified.length > 0) {
              core.setFailed(
                `Invalid commit signatures found: ${blockingUnverified
                  .map(c => `${c.sha.substring(0, 8)} (${c.commit?.verification?.reason || 'unknown'})`)
                  .join(', ')}`
              );
              return;
            }

            core.info(`All ${commits.length} commits are signed and verified.`);
